name: EppoEngine CI

on:
  workflow_dispatch:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]

jobs:
  setup:
    runs-on: [ self-hosted, windows ]
    name: "Build"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Premake
        uses: abel0b/setup-premake@v2.3
        with:
          version: "5.0.0-beta2"
          path: Vendor/Premake/Bin

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1.3.1
      
      - name: Run Premake
        working-directory: ${{env.GITHUB_WORKSPACE}}
        run: Vendor/Premake/Bin/Premake5.exe vs2022

      - name: "Build (Debug)"
        run: msbuild /m /p:Configuration=Debug EppoEngine.sln

      - name: "Test (Debug)"
        working-directory: ${{env.GITHUB_WORKSPACE}}
        shell: cmd
        run: .\Bin\Debug-windows-x86_64\EppoTesting\EppoTesting.exe
      
      - name: "Build and Test (Release)"
        run: msbuild /m /p:Configuration=Release EppoEngine.sln
  
      - name: "Build and Test (Dist)"
        run: msbuild /m /p:Configuration=Dist EppoEngine.sln